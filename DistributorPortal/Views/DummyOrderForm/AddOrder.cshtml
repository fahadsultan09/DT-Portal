@model OrderViewModel
@{
    ViewData["Title"] = "Add Order";
    var m =  new OrderValueViewModel();
    var id = 1;
}

<style>
    .ordervalue > tbody > tr > td {
        text-align: center;
        vertical-align: middle;
        padding: 1px;
    }

    .ordervalue > thead > tr > th {
        text-align: center;
        vertical-align: middle;
        padding: 0;
    }

    .ordervalue > tr {
        padding: 0;
        font-size: 11px
    }

    .card-header {
        padding: 5px 15px 0px 46%;
    }

    div.sticky {
        position: -webkit-sticky;
        position: sticky;
        top: 0;
        z-index: 1
    }

    body {
        overflow-x: hidden;
    }

    .col-lg-2 {
        flex-basis: 10.6667%
    }
</style>
<!-- Main content -->

<form asp-controller="DummyOrderForm"
      asp-action="SaveEdit"
      id="frmOrderMaster"
      data-ajax-begin="LaddaBegin"
      data-ajax-success="OnSuccess"
      data-ajax-complete="Complete"
      data-ajax="true"
      data-ajax-method="POST"
      enctype="multipart/form-data">
    @Html.HiddenFor(e => e.SubmitStatus, htmlAttributes: new { Id = "SubmitStatus" })
    @Html.HiddenFor(e => e.Id)
    <div class="content-wrapper">
        <section class="content-header">
            <div class="container-fluid sticky" id="pageHeader">
                <div class="row">
                    <div class="col-12">
                        <div class="card card-primary h-90">
                            <div class="card-header">
                                <h3 class="card-title text-center">Order Form</h3>
                                <div class="card-tools">
                                    <button type="button" class="btn btn-tool" data-card-widget="collapse"><i class="fas fa-minus"></i></button>
                                </div>
                            </div>
                            <div class="card-body p-0" id="UpdateOrderValueId">
                                @if (Model.Id > 0)
                                {
                                    <partial name="OrderValue" model="Model.OrderValues"/>
                                }
                                else
                                {
                                    <partial name="OrderValue" model="m"/>
                                }
                                
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="container-fluid">
                <div class="row">
                    <div class="col-12">
                        <div class="card card-primary grid">
                            <div class="card-header">
                                <h3 class="card-title">Order Quantities</h3>
                                <div class="card-tools">
                                    <button type="button" class="btn btn-tool" data-card-widget="maximize"><i class="fas fa-expand"></i></button>
                                    <button type="button" class="btn btn-tool" data-card-widget="collapse"><i class="fas fa-minus"></i></button>
                                </div>
                            </div>
                            <div class="card-body">

                                <div class="row">
                                    <div class="col-lg-12">
                                        <table id="example1" class="table table-bordered table-condensed table-hover table-striped table-sm" style="width: 100%">
                                            <thead>
                                                <tr>
                                                    <th>Code</th>
                                                    <th>Product Name</th>
                                                    <th>Pack Size</th>
                                                    <th>Carton Size</th>
                                                    <th>SF Size</th>
                                                    <th>Qty. (Units)</th>
                                                    <th>Pending Qty</th>
                                                    <th>Current Stock</th>
                                                    <th>Trade Price</th>
                                                    <th>Discount</th>
                                                    <th>Net Value</th>
                                                    <th>QTY. (CTN)</th>
                                                    <th>QTY. (SF)</th>
                                                    <th>QTY. (Loose)</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @for (int i = 0; i < Model.ProductDetails.Count(); i++)
                                                {
                                                    <tr>
                                                        <td>
                                                            @Html.HiddenFor(e => Model.ProductDetails[i].Id)
                                                            @Html.HiddenFor(e => Model.ProductDetails[i].ProductDetail.ProductMasterId)
                                                            @Model.ProductDetails[i].ProductDetail.ProductMaster.SAPProductCode
                                                        </td>
                                                        <td>@Model.ProductDetails[i].ProductDetail.ProductMaster.ProductDescription</td>
                                                        <td>@Model.ProductDetails[i].ProductDetail.ProductMaster.PackSize</td>
                                                        <td><span class="CurtonSize">@Model.ProductDetails[i].ProductDetail.ProductMaster.CartonSize</span></td>
                                                        <td>@Model.ProductDetails[i].ProductDetail.ProductMaster.SFSize</td>
                                                        <td>
                                                            @Html.TextBoxFor(e => Model.ProductDetails[i].ProductDetail.ProductMaster.Quantity, htmlAttributes: new { tabindex = id, type = "number", value = Model.ProductDetails[i].ProductDetail.ProductMaster.Quantity, ProductId = Model.ProductDetails[i].ProductDetail.ProductMaster.Id, onchange = "LoadOrderValue(this);", @class = "form-control ApproveQuantity", min = "0", max = "9999999", step = "any" })
                                                        </td>
                                                        <td>@Model.ProductDetails[i].ProductDetail.PendingQuantity</td>
                                                        <td></td>
                                                        <td>@Html.TextBoxFor(e => Model.ProductDetails[i].ProductPrice, htmlAttributes: new { @class = "form-control TradePrice", @readonly = true })</td>
                                                        <td><span class="Discount">@Model.ProductDetails[i].Discount</span> %</td>
                                                        @*<td><span class="TotalPrice"></span></td>*@
                                                        <td>@Html.TextBoxFor(e => Model.ProductDetails[i].ProductDetail.TotalPrice, htmlAttributes: new { @class = "form-control TotalPrice", @readonly = true, type = "number" })</td>
                                                        <td><span class="CurtonQty"></span></td>
                                                        <td><span class="QtySF"></span></td>
                                                        <td><span class="QtyLoose"></span></td>
                                                    </tr>
                                                    id++;
                                                }

                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-lg-1 offset-11">
                                        <button type="button" onclick="LoadModal();" class="btn btn-primary pull-right" style="margin-top: 28px"><i class="fa fa-arrow-right"></i>&nbsp;Next</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>
    <div class="modal fade" id="modal-OrderModal" aria-modal="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary">
                    <h4 class="modal-title">Create New Order</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">×</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                            <label>Additional Information</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="row">

                            <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                                <h6>Reference No</h6>
                                <input type="text" asp-for="@Model.ReferenceNo" id="ReferenceNo" class="form-control" />
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                                <h6>Attachment</h6>
                                <div class="form-group">
                                    <div class="custom-file">
                                        <input type="file" asp-for="@Model.AttachmentFormFile" class="form-control custom-file-input" id="customFile" accept="application/pdf, image/*" />
                                        <label class="custom-file-label" for="customFile">Choose file</label>
                                        <span asp-validation-for="@Model.AttachmentFormFile" class="text-danger"></span>
                                    </div>
                                </div>
                                <span class="caption">
                                    <a asp-action="GetFile" asp-controller="Home" asp-route-filepath="@(Model != null & !string.IsNullOrEmpty(Model.Attachment) ? Model.Attachment : "")" target="_blank">@(Model != null & !string.IsNullOrEmpty(Model.Attachment) ? Model.Attachment.Split('_')[1] : "")</a>
                                </span>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                                <h6>Remarks</h6>
                                <input type="text" asp-for="@Model.Remarks" id="Remarks" class="form-control" />
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    <button type="button" onclick="SaveEdit('OrderNow');" class="btn btn-success" id="btnOrderNow">Order Now</button>
                    <button type="button" class="btn btn-primary" onclick="SaveEdit('Draft');" id="btnDraft">Draft</button>
                </div>
            </div>
        </div>
    </div>
</form>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>

<script>
    function LoadModal() {
        $('#modal-OrderModal').modal('toggle');
    }
    function LaddaBegin() {
        BlockUI();
        Ladda.create($("#btnOrderNow", this)[0]).start();
        Ladda.create($("#btnDraft", this)[0]).start();
    }

    function SaveEdit(e) {
        $('#example1').dataTable().fnDestroy();
        $("#example1").DataTable({
            "lengthMenu": [[-1], ["All"]]
        });
        if (e == 'OrderNow') {
            $('#SubmitStatus').val('1');
            Swal.fire({
                html: "<p style='text-align: justify'>All prices and order amount are based on current rates which are subject to change without prior notice. Invoicing will be done according to the rate exist at the time of delivery and the same would be payable by the customer. In case of any error, the company reserves the right to re-invoice with correct price</p>",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, Order Place!'
            }).then((result) => {
                if (result.value == true) {
                    $('#frmOrderMaster').submit();
                }
            });
        }
        else {
            $('#SubmitStatus').val('2');
            $('#frmOrderMaster').submit();
        }
    }

    $(document).ready(function () {
        $("#example1").DataTable({
            scrollX: true,
            scrollY: "410px",
            sScrollXInner: "150%",
            scrollCollapse: true,
            paging: false,
            fixedColumns: {
                leftColumns: 4
            },
            lengthMenu: [[14, 25, 50, -1], [14, 25, 50, "All"]],
            responsive: true,
            autoWidth: false,
            order: []
        });
        $("input").not($(":submit, :button")).keypress(function (evt) {
            if (evt.keyCode == 13) {
                var next = $('[tabindex="' + (this.tabIndex + 1) + '"]');
                if (next.length) {
                    next.focus();
                    if (next.val() == '0') {
                        next.val('');
                    }
                }
                else
                    $('[tabindex="1"]').focus();
            }

        });
    });

    function LoadOrderValue(data){
            var intmaxvalue = @Int32.MaxValue;
            var quantity = data.value;
            var product = data.getAttribute("ProductId");
            if (quantity > intmaxvalue) {
                Toast.fire({
                    icon: 'error',
                    title: "Quantity cannot be greater than " + intmaxvalue
                });
            }
            else {
                var qty = parseInt(quantity);
                var size = parseInt($(data).parent('td').parent('tr').find('.CurtonSize').text());
                var tradePrice = parseInt($(data).parent('td').parent('tr').find('.TradePrice').val());
                var discount = parseInt($(data).parent('td').parent('tr').find('.Discount').text());
                var netValue = (tradePrice * qty) + (((tradePrice * qty) / 100) * discount);
                $(data).parent('td').parent('tr').find('.TotalPrice').val(netValue);
                //$(data).parent('td').parent('tr').find('#NetValue').val().mask('000,000,000,000');


                if (quantity == "" || quantity == "0") {
                    $(date).val('1');
                    quantity = data.currentTarget.value;
                }
                if (quantity != "" && quantity != undefined) {
                    if (size != 0) {
                        $(data).parent('td').parent('tr').find('.CurtonQty')[0].innerText = Math.ceil(parseInt(quantity) / size).toString();
                    }
                    else {
                        $(data).parent('td').parent('tr').find('.CurtonQty')[0].innerText = 0;
                    }
                }
                else {
                    $(data).parent('td').parent('tr').find('.CurtonQty')[0].innerText = "";
                }

                $.ajax({
                    type: "GET",
                    url: '@Url.Action("ApprovedOrderValue", "DummyOrderForm")',
                    data: { 'Quantity': quantity, 'Product': product },
                    cache: false,
                    success: function(response) {
                        debugger;
                        $("#UpdateOrderValueId").html(response);
                    },
                    complete: function(response) {

                    }
                });
            }
    }
    function SubmitForm() {

        Swal.fire({
            title: 'Are you sure?',
            html: "<p style='text-align: justify'>All prices and order amount are based on current rates which are subject to change without prior notice. Invoicing will be done according to the rate exist at the time of delivery and the same would be payable by the customer. In case of any error, the company reserves the right to re-invoice with correct price</p>",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes, Order Place!'
        }).then((result) => {
            if (result.value == true) {
                $('#frmOrderMaster').submit();
            }
        });
        return false;
    }
</script>

